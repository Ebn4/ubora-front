<form action="" [formGroup]="form" class="my-2" (submit)="onSubmit()">

  <!-- Contenu principal - Critères (EN PREMIER) -->
  <div class="grid gap-4" formArrayName="crv">
    @for (c of crv.controls; track $index) {
      <div class="mb-4" [formGroupName]="$index">
        <label class="block text-gray-700 font-medium mb-2">
          {{ criterias().at($index)?.name }}
          <span class="text-gray-500 font-normal">(sur {{ criterias().at($index)?.ponderation }})</span>
          <span class="text-red-500">*</span>
        </label>

        <!-- Description du critère -->
        @if (criterias().at($index)?.description) {
          <p class="text-sm text-gray-600 mb-3 bg-gray-50 p-2 rounded">
            {{ criterias().at($index)?.description }}
          </p>
        }

        @if (readonly) {
          <!-- Mode lecture seule -->
          <div class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700">
            {{ c.get('result')?.value || 'Non noté' }}
          </div>
        } @else {
          <!-- Mode éditable -->
          <input
            type="number"
            formControlName="result"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
            step="0.5"
            min="0.5"
            [max]="criterias().at($index)?.ponderation ?? null"
          />

          <!-- Message d'erreur pour le critère -->
          @if (c.get('result')?.invalid && c.get('result')?.touched) {
            <div class="mt-1 text-sm text-red-600">
              @if (c.get('result')?.hasError('required')) {
                <span>La note est obligatoire</span>
              }
              @if (c.get('result')?.hasError('min')) {
                <span>La note minimale est 0.5</span>
              }
              @if (c.get('result')?.hasError('max')) {
                <span>La note maximale est {{ criterias().at($index)?.ponderation }}</span>
              }
            </div>
          }
        }
      </div>
    }
  </div>

  <!-- Section Observation Générale (À LA FIN) -->
  <div class="mt-8 mb-6">
    <label class="block text-gray-700 font-medium mb-2">
      Observation générale sur l'entretien
      <span class="text-red-500">*</span>
      @if (!readonly) {
        <span class="text-gray-500 font-normal text-sm">(obligatoire, minimum 10 caractères)</span>
      }
    </label>

    @if (readonly) {
      <!-- Mode lecture seule -->
      <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px]">
        <p class="text-gray-700 whitespace-pre-line">
          {{ generalObservation.value || 'Aucune observation générale' }}
        </p>
      </div>
    } @else {
      <!-- Mode éditable -->
      <div class="relative">
        <textarea
          [formControl]="generalObservation"
          rows="4"
          placeholder="Notez ici vos observations générales sur l'entretien : impression, points forts, points à améliorer, recommandations..."
          class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition-colors resize-y"
          [class]="generalObservation.invalid && generalObservation.touched
            ? 'border-red-300 focus:border-red-500 focus:ring-red-200'
            : 'border-gray-300 focus:border-primary'"
          maxlength="2000"
        ></textarea>

        <!-- Message d'erreur -->
        @if (generalObservation.invalid && generalObservation.touched) {
          <div class="mt-1 text-sm text-red-600">
            @if (generalObservation.hasError('required')) {
              <span>L'observation est obligatoire</span>
            }
            @if (generalObservation.hasError('minlength')) {
              <span>L'observation doit contenir au moins 10 caractères</span>
            }
          </div>
        }
      </div>

      <!-- Compteur de caractères -->
      <div class="flex justify-between items-center mt-1">
        <span class="text-xs text-gray-500">
          {{ generalObservation.value?.length || 0 }} / 2000 caractères
        </span>
      </div>
    }
  </div>

  <!-- Bouton seulement si éditable -->
  @if (!readonly && !hasSelected) {
    <button
      type="submit"
      [disabled]="!form.valid || !generalObservation.valid"
      class="w-full bg-primary hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
      Soumettre l'évaluation
    </button>
  }

</form>
